<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="main.css">
    <script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdns-files.dzcdn.net/js/min/dz-v00350607.js"></script>
  </head>
 
  <body>
  <div id="wrapper" class="container">
    <div class="row">
     <div id="section_left" class="col-md-4"></div>

        <div class="container col-md-4" id="main">
          <img id="mic" src="/images/mic.png">

          <div id="dz-root"></div>
          <div id="player" align="center"></div>

          <table id="mainPlaylist" class="table table-striped col-md-12" >
            <thead>
              <tr>
                <th class="text-center">Track Name</th>
                <th class="text-center">Artist</th>
                <th class="text-center sort-default">Votes</th>  
              </tr>
            </thead>
            <tbody id="mainPlaylistRow">
            </tbody>
          </table>
          <div id="users">Current users: </div>
          <hr>
          <div id="vote_feed"></div>
      </div>

      <div id="section_right" class="col-md-4"></div>
    </div>

    <div id="bottom_section">
    <h1>Bottom</h1>
    </div>
  </div>
<script>
  // Load all songs from database on page load and build initial table 
  $(document).ready(function(){
     $.getJSON({
      url: '/songs',
      success: function(response){
        response.forEach(function(json){
          var row = `<tr id="${json.track_id}">
                     <td class="text-center">${json.track_name}</td>
                     <td class="text-center">${json.track_artist}</<td>
                     <td class="text-center">${json.votes}</td>
                     </tr>`;
          $('#mainPlaylistRow').append(row)
        })
      sort.refresh()
      }
    });
  })
</script>
<script src='/socket.io/socket.io.js'></script> 
<script></script>
<script>
  var socket = io();

  socket.on('broadcast track', function(track_id, track_name, artist){
    var row = `<tr id="${track_id}">
               <td class="text-center">${track_name}</td>
               <td class="text-center">${artist}</<td>
               <td class="text-center">0</td>
               </tr>`;
    $('#mainPlaylistRow').append(row)
  })

  socket.on('increase votes', function(user_name, track_id){
    id = $(`#${track_id}`).children().last().html();
    id = Number(id) + 1 
    $(`#${track_id}`).children().last().html(id)
    if (user_name == null) {
      $('#vote_feed').append(`<p>A user liked a song</p>`)
    } else {
      $('#vote_feed').append(`<p>${user_name} liked a song</p>`)
      sort.refresh()
    }
  })

  socket.on('decrease votes', function(user_name, track_id){
    id = $(`#${track_id}`).children().last().html();
    id = Number(id) - 1 
    $(`#${track_id}`).children().last().html(id)
    if (user_name == null) {
      $('#vote_feed').append(`<p>A user disliked a song</p>`)
    } else {
      $('#vote_feed').append(`<p>${user_name} disliked a song</p>`)
      sort.refresh()
    }
  })

  socket.on('send names', function(name, id){
    $('#users').append(`<p data-id=${id}>${name} </p>`)
  })
  
  socket.on('delete name', function(name, id){
    $(`p[data-id=${id}`).remove();
  })

  var counter = 1
  socket.on('picture upload', function(picture, filename){
    // Create random numbers between 0 and the width/height
    // Set inital left and top positions
    var width = 200
    var height = 300
    // var posX = Math.floor(Math.random()*(width - width))
    // var posY = Math.floor(Math.random()*(body.height - height))

    if ( counter % 3 == 0 ) {
      $('#section_left').append(`<img id="${filename}" class="user_pic" src="/uploads/${picture}">`)
      var parentElement = document.getElementById(`${filename}`).parentElement.getBoundingClientRect();
      var posX = Math.floor(Math.random()*(parentElement.width - width))
      var posY = Math.floor(Math.random()*(parentElement.height - height))
    } 
    else if ( counter % 2 == 0 ) {
      $('#section_right').append(`<img id="${filename}" class="user_pic" src="/uploads/${picture}">`)
      var parentElement = document.getElementById(`${filename}`).parentElement.getBoundingClientRect();
      var posX = Math.floor(Math.random()*(parentElement.width - width))
      var posY = Math.floor(Math.random()*(parentElement.height - height))
    } 
    else if ( counter % 1 == 0 ) {
      $('#bottom_section').append(`<img id="${filename}" class="user_pic" src="/uploads/${picture}">`)
      var parentElement = document.getElementById(`${filename}`).parentElement.getBoundingClientRect();
      var posX = Math.floor(Math.random()*(parentElement.width - width))
      var posY = Math.floor(Math.random()*(parentElement.height - height))
    }
    counter++
    console.log(counter)
    $(`#${filename}`).css({ 'position': 'relative', 'left': posX, 'top': posY })
    
    // while (   !((posY  + height) < mainBounds.top && posY > mainBounds.bottom)  ) {
    //   posY = Math.floor(Math.random()*(body.height - height))
    // }

    // while (   !((posX  + width) < mainBounds.left && posX > mainBounds.right)  ) {
    //   posX = Math.floor(Math.random()*(body.width - width))
    // }

  })

  DZ.init({
    appId  : '190182',
    channelUrl : 'https://example@example.com',
    player : {
      container : 'player',
      playlist : false,
      size: 'big',
      onload : onPlayerLoaded
    }
  });

  function onPlayerLoaded() {
    // DZ.player.playTracks([15246481]);

    DZ.Event.subscribe('track_end', function(){
      var track_id = parseInt($("#mainPlaylist tbody tr:nth-child(1").attr('id'))
      DZ.player.playTracks([track_id], function(){
        $(`#${track_id}`).remove();
        socket.emit('delete track', track_id)
      });
    })   
  }

</script>
<script src="tablesort.min.js"></script>
<script src="tablesort.number.js"></script>
<script>
  sort = new Tablesort(document.getElementById('mainPlaylist'), {
    descending: true
  });
</script>
</body>
</html>


<!--     var width = 200
    var height = 300
    
    var posX = Math.floor(Math.random()*(bodyWidth.width - width))
    var posY = Math.floor(Math.random()*(bodyHeight.height - height))

    // Get main element, do calculation to prevent overlap
    mainBounds = document.getElementById('main').getBoundingClientRect()
    if ( ((posY  + height) < mainBounds.top) && (posY > mainBounds.bottom) ) {
      posX = posX
    } else {
      
    }
 -->